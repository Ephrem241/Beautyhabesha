generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum EscortStatus {
  pending
  approved
  rejected
  suspended
}

enum BookingMode {
  online
  in_person
}

enum BookingStatus {
  pending
  approved
  rejected
  completed
  canceled
}

enum DepositStatus {
  pending
  approved
  rejected
}

enum DepositPaymentMethod {
  telebirr
  bank_transfer
  cash
}

enum ReportReason {
  fake_profile
  underage
  abuse
  scam
}

enum ReportStatus {
  pending
  reviewed
  action_taken
}

enum BillingCycle {
  monthly
  yearly
}

model User {
  id                    String         @id @default(cuid())
  email                 String?        @unique
  username              String?        @unique
  age                   Int?
  password              String?
  name                  String?
  role                  String         @default("user")
  currentPlan           String?        @default("Normal")
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  subscriptionStatus    String?        @default("inactive")
  subscriptionPlanId    String?
  autoRenew             Boolean        @default(false)
  renewalAttempts       Int            @default(0)
  lastRenewalAttempt    DateTime?
  bannedAt              DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  escortProfile         EscortProfile?
  subscriptions         Subscription[]
  bookings              Booking[]
  depositPayments       DepositPayment[]
  consentRecords        ConsentRecord[]
  reportsFiled          Report[]       @relation("ReportReporter")
  subscriptionPlan      SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id], onDelete: SetNull)
  payments              Payment[]
  chatRooms             ChatRoom[]     @relation("ChatRoomOwner")
  chatMessages          Message[]      @relation("MessageSender")

  @@index([role])
  @@index([subscriptionEndDate])
  @@index([subscriptionStatus])
  @@index([subscriptionPlanId])
  @@index([createdAt(sort: Desc)])
  @@map("users")
}

model EscortProfile {
  id                 String       @id @default(cuid())
  userId             String       @unique
  displayName        String
  bio                String?
  description        String?   @db.Text
  city               String?
  price              Int?
  available          Boolean      @default(true)
  images             Json         @default("[]")
  phone              String?
  telegram           String?
  whatsapp           String?
  status             EscortStatus @default(pending)
  approvedAt         DateTime?
  approvedBy         String?
  createdAt          DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  lastActiveAt       DateTime?
  rankingBoostUntil  DateTime?
  rankingSuspended  Boolean      @default(false)
  manualPlanId       String?
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings          Booking[]
  availabilities     Availability[]
  reports            Report[]

  @@index([status, createdAt(sort: Desc)])
  @@index([lastActiveAt(sort: Desc)])
  @@index([city])
  @@index([displayName])
  @@map("escort_profiles")
}

model ConsentRecord {
  id         String   @id @default(cuid())
  userId     String
  type       String   // terms | content | 18_plus | ownership
  version    String
  acceptedAt DateTime @default(now())
  ip         String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@map("consent_records")
}

model Report {
  id             String       @id @default(cuid())
  escortProfileId String
  reporterUserId  String?
  reason         ReportReason
  details        String?
  status         ReportStatus @default(pending)
  reviewedAt     DateTime?
  reviewedBy     String?
  createdAt      DateTime     @default(now())
  escortProfile  EscortProfile @relation(fields: [escortProfileId], references: [id], onDelete: Cascade)
  reporter       User?        @relation("ReportReporter", fields: [reporterUserId], references: [id], onDelete: SetNull)

  @@index([escortProfileId])
  @@index([status])
  @@index([reporterUserId])
  @@map("reports")
}

model Availability {
  id          String       @id @default(cuid())
  escortId    String
  date        DateTime     @db.Date
  startTime   String
  endTime     String
  mode        BookingMode
  isBooked    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  escortProfile EscortProfile @relation(fields: [escortId], references: [id], onDelete: Cascade)

  @@index([escortId])
  @@index([escortId, date])
  @@index([date])
  @@map("availabilities")
}

model Plan {
  id           String   @id @default(cuid())
  name         String   @unique
  price        Float
  durationDays Int
  features     String[]
  priority     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("plans")
}

model PaymentAccount {
  id            String   @id @default(cuid())
  type          String   // "bank" | "mobile_money"
  accountName   String
  accountNumber String
  provider      String?  // e.g. "TeleBirr" for mobile_money
  displayOrder  Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive, displayOrder])
  @@map("payment_accounts")
}

model SubscriptionPlan {
  id            String       @id @default(cuid())
  name          String
  slug          String       @unique
  price         Float
  currency      String       @default("ETB")
  billingCycle  BillingCycle @default(monthly)
  features      String[]     @default([])
  durationDays  Int          @default(30)
  isPopular     Boolean      @default(false)
  isRecommended Boolean      @default(false)
  isActive      Boolean      @default(true)
  deletedAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  users         User[]
  subscriptions Subscription[]
  paymentRecords Payment[]         @relation("PlanPayments")

  @@index([slug])
  @@index([isActive, deletedAt])
  @@map("subscription_plans")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  planId               String
  subscriptionPlanId   String?
  status               String    @default("pending")
  paymentMethod        String
  paymentProofUrl      String
  paymentProofPublicId String
  rejectionReason      String?
  approvedAt           DateTime?
  startDate            DateTime?
  endDate              DateTime?
  lastNotifiedAt       DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionPlan     SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id], onDelete: SetNull)

  @@index([status, endDate])
  @@index([userId, status])
  @@index([endDate])
  @@index([subscriptionPlanId])
  @@map("subscriptions")
}

model Booking {
  id                String        @id @default(cuid())
  userId            String
  escortId          String
  date              DateTime      @db.Date
  startTime         String
  endTime           String
  mode              BookingMode
  status            BookingStatus @default(pending)
  depositAmount     Float
  escortAcceptedAt  DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  escortProfile     EscortProfile @relation(fields: [escortId], references: [id], onDelete: Cascade)
  depositPayments   DepositPayment[]

  @@index([userId])
  @@index([escortId])
  @@index([escortId, date])
  @@index([status])
  @@index([date])
  @@map("bookings")
}

enum PaymentStatus {
  pending
  approved
  rejected
}

enum PaymentMethod {
  telebirr
  cbe
  bank
}

model Payment {
  id             String        @id @default(cuid())
  userId         String
  planId         String
  amount         Float
  receiptUrl     String
  paymentMethod  PaymentMethod
  status         PaymentStatus @default(pending)
  rejectionReason String?
  approvedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan           SubscriptionPlan  @relation("PlanPayments", fields: [planId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([planId])
  @@index([createdAt(sort: Desc)])
  @@map("payments")
}

model DepositPayment {
  id             String              @id @default(cuid())
  bookingId      String
  userId         String
  amount         Float
  paymentMethod  DepositPaymentMethod
  receiptUrl     String
  receiptPublicId String?
  status         DepositStatus       @default(pending)
  rejectionReason String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  booking        Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@map("deposit_payments")
}

model ChatRoom {
  id        String    @id @default(cuid())
  userId    String
  resolved  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user     User      @relation("ChatRoomOwner", fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([resolved])
  @@index([updatedAt(sort: Desc)])
  @@map("chat_rooms")
}

model Message {
  id        String   @id @default(cuid())
  roomId    String
  senderId  String
  text      String?
  image     String?
  createdAt DateTime @default(now())

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([roomId, createdAt(sort: Desc)])
  @@map("messages")
}

model MessageArchive {
  id         String   @id
  roomId     String
  senderId   String
  text       String?
  image      String?
  createdAt  DateTime
  archivedAt DateTime @default(now())

  @@index([roomId])
  @@index([createdAt])
  @@map("message_archives")
}

model PaymentArchive {
  id              String        @id
  userId          String
  planId          String
  amount          Float
  receiptUrl      String
  paymentMethod  PaymentMethod
  status         PaymentStatus
  rejectionReason String?
  approvedAt     DateTime?
  createdAt      DateTime
  updatedAt      DateTime
  archivedAt     DateTime      @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("payment_archives")
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String   // comma-separated if multiple
  subject   String
  type      String   // e.g. payment_upload_user, payment_upload_admin, booking_request
  metadata  Json?
  sentAt    DateTime @default(now())

  @@index([type])
  @@index([sentAt(sort: Desc)])
  @@map("email_logs")
}
